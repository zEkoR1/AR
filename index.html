<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebAR Lab - AR Experience</title>
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>
    <script>
      (function () {
        if (
          window.THREE &&
          THREE.Matrix4 &&
          !THREE.Matrix4.prototype.invert &&
          THREE.Matrix4.prototype.getInverse
        ) {
          THREE.Matrix4.prototype.invert = function () {
            const clone = this.clone();
            return this.getInverse(clone);
          };
        }
      })();
    </script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: system-ui, sans-serif;
      }
      #story-box {
        position: fixed;
        top: 80%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, rgba(20, 20, 60, 0.95) 0%, rgba(40, 10, 60, 0.95) 100%);
        border: 3px solid gold;
        border-radius: 15px;
        padding: 30px 40px;
        max-width: 500px;
        text-align: center;
        z-index: 10;
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.5), inset 0 0 20px rgba(255, 215, 0, 0.1);
        font-size: 24px;
        font-weight: bold;
        color: #FFD700;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        display: none;
      }
      #overlay {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.65);
        color: white;
        padding: 10px;
        border-radius: 6px;
        font-size: 14px;
        z-index: 2;
        max-width: 360px;
      }
      #overlay p {
        margin: 6px 0;
      }
      button {
        margin: 4px 6px 4px 0;
        padding: 6px 10px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        background: #4cc3d9;
        color: #000;
      }
      #hint {
        margin-top: 8px;
        color: #ffd;
        font-size: 13px;
      }
      .small {
        font-size: 12px;
        color: #ddd;
      }
      
      #detection-status {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        font-size: 14px;
        z-index: 100;
        min-width: 250px;
        border: 2px solid #666;
      }
      
      #detection-status.detected {
        border-color: #00ff00;
        background: rgba(0, 100, 0, 0.9);
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.6);
      }
      
      .marker-status {
        display: flex;
        align-items: center;
        margin: 5px 0;
        font-weight: bold;
      }
      
      .marker-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        background: #666;
        animation: none;
      }
      
      .marker-indicator.active {
        background: #00ff00;
        animation: pulse 1s infinite;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
    </style>
  </head>

<body style="margin : 0px; overflow: hidden;">

    <div id="detection-status">
      <div style="font-size: 16px; margin-bottom: 8px; font-weight: bold;">üéØ Markers</div>
      <div class="marker-status">
        <div class="marker-indicator" id="indicator-1"></div>
        <span id="marker1-text">‚öîÔ∏è Sword: Waiting</span>
      </div>
      <div class="marker-status">
        <div class="marker-indicator" id="indicator-2"></div>
        <span id="marker2-text">üó∫Ô∏è Path: Waiting</span>
      </div>
    </div>

    <div id="overlay">
      <p id="title" style="font-weight: bold; margin-top: 0;">Knight's Quest AR</p>
      <p id="status">Status: Initializing‚Ä¶</p>
      <p>1Ô∏è‚É£ Sword: <span id="firstName" class="small">‚Äî</span></p>
      <p>2Ô∏è‚É£ Path: <span id="secondName" class="small">‚Äî</span></p>
      <div style="margin-top: 8px;">
        <button id="btn-reset">Reset</button>
      </div>
      <p id="story" class="small">Scan HIRO for sword, then pick a path.</p>
      <p id="hint" class="small">‚öîÔ∏è Castle üè∞ or üå≤ Forest</p>
    </div>

    <!-- Story text box (HTML overlay) -->
    <div id="story-box"></div>

    <!-- A-Frame scene -->
    <a-scene
      vr-mode-ui="enabled: false;"
      renderer="logarithmicDepthBuffer: true; antialias: true; colorManagement: true"
      embedded
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
    >
      <!-- Assets: Preload models -->
      <a-assets>
        <a-asset-item id="sword-model" src="models/Sword.obj"></a-asset-item>
        <a-asset-item id="tree-model" src="models/Tree.obj"></a-asset-item>
        <a-asset-item id="kale-model" src="models/towers .obj"></a-asset-item>
        <a-asset-item id="cup-model" src="models/1.obj"></a-asset-item>
      </a-assets>

      <!-- Lighting -->
      <a-entity light="type: ambient; intensity: 1.5; color: white"></a-entity>
      <a-entity light="type: directional; intensity: 1; position: 1 2 1; color: white"></a-entity>

      <!-- CAMERA CONTAINER - All objects positioned relative to camera -->
      <a-entity id="mainCamera" camera>
        <!-- Object 1: Sword (shown when marker1 scanned) -->
        <a-entity
          id="object1"
          position="0 0 -5"
          rotation="0 0 0"
          scale="0.2 0.2 0.2"
          visible="false"
        >
          <a-obj-model src="#sword-model" scale="0.5 0.5 0.5" material="color: #C0C0C0; metalness: 0.9; roughness: 0.1;"></a-obj-model>
        </a-entity>

        <!-- Object 2: Castle (Tower) (shown when marker2 scanned) -->
        <a-entity
          id="object2"
          position="0 0 -5"
          rotation="0 0 0"
          scale="0.2 0.2 0.2"
          visible="false"
        >
          <a-obj-model src="#kale-model" scale="0.5 0.5 0.5" material="color: #808080; metalness: 0.3; roughness: 0.7;"></a-obj-model>
        </a-entity>

        <!-- Object 3: Forest (Tree) (shown when marker3 scanned) -->
        <a-entity
          id="object3"
          position="0 0 -5"
          rotation="0 0 0"
          scale="0.2 0.2 0.2"
          visible="false"
        >
          <a-obj-model src="#tree-model" scale="0.5 0.5 0.5"></a-obj-model>
        </a-entity>

        <!-- Object 4: Cup (shown when marker4 scanned) -->
        <a-entity
          id="object4"
          position="0 0 -5"
          rotation="0 0 0"
          scale="0.15 0.15 0.15"
          visible="false"
        >
          <a-obj-model src="#cup-model" scale="0.5 0.5 0.5" material="color: #FFD700; metalness: 0.8; roughness: 0.2;"></a-obj-model>
        </a-entity>

        <!-- Text display -->
        <a-text
          id="story-text"
          value="Welcome..."
          position="0 1.5 -3"
          rotation="0 0 0"
          scale="2 2 2"
          color="gold"
          align="center"
          visible="true"
        ></a-text>
      </a-entity>

      <!-- MARKER 1: HIRO (built-in) - Only used as trigger -->
      <a-marker id="marker1" type="hiro" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5">
      </a-marker>

      <!-- MARKER 2: pattern-kanji - Castle -->
      <a-marker id="marker2" type="pattern" url="pattern-kanji.patt" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5">
      </a-marker>

      <!-- MARKER 3: pattern-letterA - Forest -->
      <a-marker id="marker3" type="pattern" url="pattern-letterA.patt" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5">
      </a-marker>

      <!-- MARKER 4: pattern-letterB - Victory -->
      <a-marker id="marker4" type="pattern" url="pattern-letterB.patt" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5">
      </a-marker>
    </a-scene>

    <script>
      // State
      const scanned = { marker1: false, marker2: false, marker3: false, marker4: false };
      let activeObject = null;
      let activePathMarker = null; // Track if player chose castle (marker2) or forest (marker3)
      const unlockTree = { 
        marker1: null, 
        marker2: "marker1",
        marker3: "marker1",
        marker4: null  // Victory has custom logic based on path
      };

      // DOM refs
      const marker1 = document.getElementById("marker1");
      const marker2 = document.getElementById("marker2");
      const marker3 = document.getElementById("marker3");
      const marker4 = document.getElementById("marker4");
      const object1 = document.getElementById("object1");
      const object2 = document.getElementById("object2");
      const object3 = document.getElementById("object3");
      const object4 = document.getElementById("object4");
      const storyText = document.getElementById("story-text");

      const status = document.getElementById("status");
      const btnReset = document.getElementById("btn-reset");
      const descFirst = document.getElementById("firstName");
      const descSecond = document.getElementById("secondName");
      const storyElement = document.getElementById("story");
      const detectionDiv = document.getElementById("detection-status");

      const detectionUI = {
        marker1: {
          indicator: document.getElementById("indicator-1"),
          text: document.getElementById("marker1-text"),
        },
        marker2: {
          indicator: document.getElementById("indicator-2"),
          text: document.getElementById("marker2-text"),
        },
      };

      const artifactMeta = {
        marker1: {
          element: object1,
          name: "Sword",
          spin: { to: "0 360 0", dur: 9000 },
          text: "The knight takes the sword!"
        },
        marker2: {
          element: object2,
          name: "Castle",
          spin: { to: "0 -360 0", dur: 7500 },
          text: "He enters the castle..."
        },
        marker3: {
          element: object3,
          name: "Forest",
          spin: { to: "0 360 0", dur: 8000 },
          text: "He enters the dark forest..."
        },
        marker4: {
          element: object4,
          name: "Cup",
          spin: { to: "0 -360 0", dur: 6000 },
          text: "Victory! The knight wins the cup!"
        },
      };

      if (descFirst) descFirst.textContent = artifactMeta.marker1?.name || "Artifact 1";
      if (descSecond) descSecond.textContent = artifactMeta.marker2?.name || "Artifact 2";

      // Utility functions
      function hideAllObjects() {
        [object1, object2, object3, object4].forEach((obj) => {
          if (obj) {
            obj.setAttribute("visible", false);
            obj.removeAttribute("animation__spin");
          }
        });
      }

      function ensureSpin(element, spinConfig = {}) {
        if (!element) return;
        const { to = "0 360 0", dur = 9000 } = spinConfig;
        element.removeAttribute("animation__spin");
        element.setAttribute(
          "animation__spin",
          `property: rotation; to: ${to}; loop: true; dur: ${dur}; easing: linear`
        );
        console.log(`üåÄ Spin started: to=${to}, dur=${dur}`);
      }

      function showObjectForMarker(markerId) {
        const artifactInfo = artifactMeta[markerId];
        if (!artifactInfo || !artifactInfo.element) {
          console.error(`showObjectForMarker: artifact info missing for ${markerId}`);
          return;
        }

        // Check prerequisites
        const prerequisite = unlockTree[markerId];
        if (prerequisite && !scanned[prerequisite]) {
          const prerequisiteName = artifactMeta[prerequisite]?.name || prerequisite;
          setStatus(
            `${artifactInfo.name} waits for ${prerequisiteName} to be awakened first.`
          );
          setStory(`Scan ${prerequisiteName} first.`);
          return;
        }

        // Special check for victory cup (marker4): requires sword + path
        if (markerId === "marker4") {
          if (!scanned["marker1"]) {
            setStatus("You must get the sword first!");
            setStory("Get the sword first!");
            return;
          }
          if (!activePathMarker || (!scanned["marker2"] && !scanned["marker3"])) {
            setStatus("You must choose a path first (castle or forest)!");
            setStory("Choose a path first!");
            return;
          }
        }

        // Check castle/forest exclusivity (marker2 and marker3 are mutually exclusive)
        if ((markerId === "marker2" || markerId === "marker3") && activePathMarker) {
          if (activePathMarker !== markerId) {
            const currentPath = artifactMeta[activePathMarker]?.name || activePathMarker;
            const attemptedPath = artifactInfo.name;
            setStatus(`You already chose the ${currentPath} path. Cannot take ${attemptedPath} now.`);
            setStory(`You already entered the ${currentPath}!`);
            return;
          }
        }

        hideAllObjects();
        artifactInfo.element.setAttribute("visible", true);
        console.log(`‚úÖ Showing ${markerId}:`, artifactInfo.element);
        
        // Mark the path choice if it's castle or forest
        if (markerId === "marker2" || markerId === "marker3") {
          activePathMarker = markerId;
        }
        
        // For victory (marker4), customize text based on which path was chosen (castle OR forest)
        let storyText = artifactInfo.text;
        if (markerId === "marker4") {
          if (activePathMarker === "marker2") {
            // Castle path chosen
            storyText = "Victory! The knight defeated the monster in the castle!";
          } else if (activePathMarker === "marker3") {
            // Forest path chosen
            storyText = "Victory! The knight defeated the monster in the forest!";
          } else {
            storyText = "Scan castle or forest first.";
          }
        }
        
        ensureSpin(artifactInfo.element, artifactInfo.spin);
        activeObject = markerId;
        scanned[markerId] = true;

        setStatus("Displaying: " + artifactInfo.name);
        setStory(storyText);
      }

      function setStatus(text) {
        if (status) {
          status.textContent = "Status: " + text;
        }
      }

      function setStory(text) {
        if (storyElement) {
          storyElement.textContent = text;
        }
        if (storyText) {
          storyText.setAttribute("value", text);
        }
        // Show story box overlay
        const storyBox = document.getElementById('story-box');
        if (storyBox) {
          storyBox.textContent = text;
          storyBox.style.display = 'block';
          
          // Auto-hide after 5 seconds
          clearTimeout(storyTimeout);
          storyTimeout = setTimeout(() => {
            storyBox.style.display = 'none';
          }, 5000);
        }
      }

      let storyTimeout;

      function updateDetectionIndicator(markerId, found) {
        const ui = detectionUI[markerId];
        if (!ui) return;

        const labels = {
          marker1: "‚öîÔ∏è Sword",
          marker2: "üè∞ Castle / üå≤ Path"
        };
        const label = labels[markerId] || markerId;

        if (found) {
          ui.indicator?.classList.add("active");
          if (ui.text) ui.text.textContent = `${label}: ‚úÖ Found`;
          console.log(`‚úÖ ${label} FOUND`);
        } else {
          ui.indicator?.classList.remove("active");
          if (ui.text) ui.text.textContent = `${label}: ‚ùå Lost`;
          console.log(`‚ùå ${label} LOST`);
        }

        const anyActive = Object.values(detectionUI).some(
          ({ indicator }) => indicator && indicator.classList.contains("active")
        );
        if (detectionDiv) {
          detectionDiv.classList.toggle("detected", anyActive);
        }
      }

      function resetIndicators() {
        Object.entries(detectionUI).forEach(([markerId, ui]) => {
          ui.indicator?.classList.remove("active");
          const labels = {
            marker1: "‚öîÔ∏è Sword",
            marker2: "üó∫Ô∏è Path"
          };
          const label = labels[markerId] || markerId;
          if (ui.text) {
            ui.text.textContent = `${label}: Waiting`;
          }
        });
        detectionDiv?.classList.remove("detected");
      }

      function clearActiveIfLost(markerId) {
        if (activeObject === markerId) {
          const artifactInfo = artifactMeta[markerId];
          if (artifactInfo?.element) {
            artifactInfo.element.setAttribute("visible", false);
            artifactInfo.element.removeAttribute("animation__spin");
          }
          activeObject = null;
          console.log(`üîí Hidden ${markerId}`);
          setStatus("Object removed from view. Scan another marker.");
        }
      }

      // Marker event handlers
      if (marker1) {
        marker1.addEventListener("markerFound", () => {
          console.log("üéØ HIRO marker found");
          updateDetectionIndicator("marker1", true);
          showObjectForMarker("marker1");
        });
        marker1.addEventListener("markerLost", () => {
          console.log("‚ùå HIRO marker lost");
          updateDetectionIndicator("marker1", false);
          clearActiveIfLost("marker1");
        });
      }

      if (marker2) {
        marker2.addEventListener("markerFound", () => {
          console.log("üéØ Pattern Kanji marker found");
          updateDetectionIndicator("marker2", true);
          showObjectForMarker("marker2");
        });
        marker2.addEventListener("markerLost", () => {
          console.log("‚ùå Pattern Kanji marker lost");
          updateDetectionIndicator("marker2", false);
          clearActiveIfLost("marker2");
        });
      }

      if (marker3) {
        marker3.addEventListener("markerFound", () => {
          console.log("üéØ Pattern LetterA marker found");
          showObjectForMarker("marker3");
        });
        marker3.addEventListener("markerLost", () => {
          console.log("‚ùå Pattern LetterA marker lost");
          clearActiveIfLost("marker3");
        });
      }

      if (marker4) {
        marker4.addEventListener("markerFound", () => {
          console.log("üéØ Pattern LetterB marker found");
          showObjectForMarker("marker4");
        });
        marker4.addEventListener("markerLost", () => {
          console.log("‚ùå Pattern LetterB marker lost");
          clearActiveIfLost("marker4");
        });
      }

      if (btnReset) {
        btnReset.addEventListener("click", () => {
          Object.keys(scanned).forEach((key) => {
            scanned[key] = false;
          });
          activeObject = null;
          activePathMarker = null;
          hideAllObjects();
          resetIndicators();
          setStory("Scan the markers to reveal the artifacts.");
          setStatus("Progress reset. Scan HIRO marker to begin.");
        });
      }

      // Keyboard shortcuts for testing
      window.addEventListener("keydown", (e) => {
        if (e.key === "1") {
          showObjectForMarker("marker1");
        } else if (e.key === "2") {
          showObjectForMarker("marker2");
        } else if (e.key === "3") {
          showObjectForMarker("marker3");
        } else if (e.key === "4") {
          showObjectForMarker("marker4");
        } else if (e.key === "r" && btnReset) {
          btnReset.click();
        }
      });

      setStory("Scan the markers to reveal the artifacts.");
      setStatus("Waiting: Scan HIRO marker first, then Pattern Kanji.");
      console.log("üé® AR Lab initialized. Keys: 1=marker1, 2=marker2, 3=marker3, 4=marker4, r=reset");
    </script>
  </body>
</html>
